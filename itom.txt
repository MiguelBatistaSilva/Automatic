from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.action_chains import ActionChains
import pandas as pd
import time

# --- INPUTS INICIAIS ---
arquivo_excel = input("Caminho do arquivo Excel: ").strip()
secretaria = input("Nome da Secretaria: ").strip()

# --- L√™ o Excel ---
try:
    df = pd.read_excel(arquivo_excel)
except FileNotFoundError:
    print(f"‚ùå Erro: Arquivo n√£o encontrado no caminho: {arquivo_excel}")
    exit()

# --- Configura√ß√£o do Chrome ---
chrome_options = Options()
chrome_options.add_argument("--start-maximized")

# ATEN√á√ÉO: Verifique o caminho do chromedriver
service = Service("/home/velta-int-sys/Projects/Automatic/chromedriver-linux64/chromedriver") 
driver = webdriver.Chrome(service=service, options=chrome_options)

# --- Acessa o Assyst ---
driver.get("https://cati.tjce.jus.br/assystweb/application.do")

print("‚öôÔ∏è Fa√ßa login manualmente no Assyst...")

WebDriverWait(driver, 600).until(
    EC.presence_of_element_located((By.XPATH, "//span[contains(@class,'dijitTreeLabel') and text()='Requisi√ß√£o de Servi√ßo']"))
)
print("‚úÖ Login detectado!")


# ==============================================================================================
# FUN√á√ÉO REUTILIZ√ÅVEL: AUTOMATIZAR BASE DE CONHECIMENTO (BK)
# Cont√©m os Passos de Pesquisar BK at√© o Retorno ao Evento
# ==============================================================================================
def automatizar_bk(driver):
    """Executa a sequ√™ncia completa da Base de Conhecimento."""
    
    print("\n      -> [BK] Iniciando o processo da Base de Conhecimento...")
    
    # -- PESQUISAR (Menu Conhecimento) --
    try:
        conhecimento = WebDriverWait(driver, 15).until(
            EC.element_to_be_clickable((By.ID, "knowledgeMenu")) 
        )
        conhecimento.click()
        print("      -> [BK] Clicado no bot√£o/menu 'Conhecimento'.")
        time.sleep(3)
    except Exception as e:
        print(f"      -> [BK] ‚ùå Erro ao clicar no menu 'Conhecimento': {e}")
        return # Sai da fun√ß√£o

    # -- PALAVRA-CHAVE --
    try:
        campo_bk = WebDriverWait(driver, 15).until(
            EC.presence_of_element_located((By.ID, "NONE_knowledgeProcedure_lookup_query"))
        )
        campo_bk.clear() 
        campo_bk.send_keys("itom") 
        print("      -> [BK] Campo 'Palavra-chave' preenchido.")
    except Exception as e:
        print(f"      -> [BK] ‚ùå Erro ao preencher 'Palavra-chave BK': {e}")

    # -- LUPA --
    try:    
        botao_pesquisar_bk = WebDriverWait(driver, 15).until(
            EC.element_to_be_clickable((By.ID, "btSearch")) 
        )
        botao_pesquisar_bk.click()
        print("      -> [BK] Clicado no bot√£o 'Pesquisar'.")
        time.sleep(4)
    except Exception as e:
        print(f"      -> [BK] ‚ùå Erro ao clicar no bot√£o 'Pesquisar': {e}")

    # -- REORDENA√á√ÉO (Double Click) --
    try:
        cabecalho_classificacao = WebDriverWait(driver, 15).until(
            EC.presence_of_element_located((By.ID, "knowledgeSearch_shownValues_gridHdr1"))
        )
        actions = ActionChains(driver)
        actions.double_click(cabecalho_classificacao).perform()
        print("      -> [BK] Reordena√ß√£o da tabela conclu√≠da.")
        time.sleep(1)
    except Exception as e:
        print(f"      -> [BK] ‚ùå Erro ao reordenar a tabela: {e}")

    # -- BOT√ÉO DIREITO (Selecionar Artigo) -- 
    try:
        linha_artigo = WebDriverWait(driver, 15).until(
            EC.element_to_be_clickable((By.XPATH, "//div[contains(@class, 'dojoxGridRow') and contains(@class, 'rowId1')]")) 
        )
        actions = ActionChains(driver)
        actions.context_click(linha_artigo).perform()
        print("      -> [BK] Artigo da Base de Conhecimento selecionado.")
        time.sleep(1)
    except Exception as e:
        print(f"      -> [BK] ‚ùå Erro ao selecionar o artigo da Base de Conhecimento: {e}")

    # -- A√á√ÉO DE SOLU√á√ÉO (Clique XPath do Pai) --
    try:
        xpath_menu_item = "//td[contains(text(), 'A√ß√£o de Solu√ß√£o de Conhecimento')]/ancestor::tr[1]"
        acao_solucao_pai = WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.XPATH, xpath_menu_item)) 
        )
        acao_solucao_pai.click()
        print("      -> [BK] Clicado em 'A√ß√£o de Solu√ß√£o de Conhecimento'.")
        time.sleep(2) 
    except Exception as e:
        print(f"      -> [BK] ‚ùå Erro ao clicar na 'A√ß√£o de Solu√ß√£o de Conhecimento': {e}")

    # -- SALVAR A√á√ÉO -- 
    try:    
        botao_salvar_acao = WebDriverWait(driver, 15).until(
            EC.element_to_be_clickable((By.ID, "ManageActionForm.btSave")) 
        )
        botao_salvar_acao.click()
        print("      -> [BK] A√ß√£o de Solu√ß√£o de Conhecimento salva e confirmada.")
        time.sleep(2) 
    except Exception as e:
        print(f"      -> [BK] ‚ùå Erro ao clicar no bot√£o 'Salvar a√ß√£o': {e}")

    # -- SAIR (Voltar ao Evento) --
    try:    
        botao_voltar = WebDriverWait(driver, 15).until(
            EC.element_to_be_clickable((By.ID, "dijit_form_Button_5")) 
        )
        botao_voltar.click()
        print("      -> [BK] Retorno √† tela do Chamado conclu√≠do.")
        time.sleep(3)
    except Exception as e:
        print(f"      -> [BK] ‚ùå Erro ao clicar no bot√£o 'Voltar ao evento': {e}")


# ==============================================================================================
# FLUXO PRINCIPAL - CRIA√á√ÉO DO CHAMADO PAI
# ==============================================================================================

# 3. Expande poss√≠veis menus pais antes do clique
# ... (O c√≥digo de clique em 'Requisi√ß√£o de Servi√ßo' continua aqui)

try:
    menu_element = driver.find_element(By.XPATH, "//span[contains(@class,'dijitTreeLabel') and text()='Requisi√ß√£o de Servi√ßo']")
    driver.execute_script("arguments[0].scrollIntoView(true);", menu_element)
    driver.execute_script("arguments[0].click();", menu_element)
    print("‚úÖ Clicou em 'Requisi√ß√£o de Servi√ßo'")
except Exception as e:
    print("‚ùå Erro ao clicar:", e)

# === PREENCHIMENTO DOS CAMPOS (Usu√°rio, Resumo, Descri√ß√£o, Produtos, Categoria) ===
# ... (Todo o seu c√≥digo de preenchimento continua aqui, sem altera√ß√µes, at√© o SALVAR do Chamado Pai)
# ...

# --- USU√ÅRIO ATRIBU√çDO ---
# ... (Seu bloco de Usu√°rio Atribu√≠do)
# ...

# -- SALVAR CHAMADO PAI --
try:
    # ‚ö†Ô∏è REVIS√ÉO DO ID: btlogEvent
    botao_salvar = WebDriverWait(driver, 20).until(
        EC.element_to_be_clickable((By.ID, "btlogEvent"))  
    )
    botao_salvar.click()
    print("‚úÖ Chamado PAI salvo com sucesso.")
    time.sleep(4) 
except Exception as e:
    print(f"‚ùå Erro ao clicar no bot√£o Salvar do Chamado PAI: {e}")

# ==============================================================================================
# BASE DE CONHECIMENTO - CHAMADO PAI (Reutilizando a fun√ß√£o)
# ==============================================================================================
automatizar_bk(driver)

# ==============================================================================================
# SUPER-LOOP: CHAMADOS FILHOS
# ==============================================================================================

print("\n\n##################################")
print("# INICIANDO CRIA√á√ÉO DE CHAMADOS FILHOS #")
print("##################################")

for index, row in df.iterrows():
    nome_maquina = row['NOME']
    print(f"\n‚öôÔ∏è Processando m√°quina {index + 1}/{len(df)}: {nome_maquina}")

    # 1. CONSTRU√á√ÉO DA DESCRI√á√ÉO DO CHAMADO FILHO
    description_son = (f"Solicito instala√ß√£o do Itom no micro da {secretaria}:\n\n"
                      f"{row['MARCA/MODELO']} | Tombo: {row['TOMBO ANTIGO']}/{row['TOMBO NOVO']} | Nome: {row['NOME']}")
    
    # -- DUPLICAR --
    try:
        botao_duplicar = WebDriverWait(driver, 15).until(
            EC.element_to_be_clickable((By.ID, "btlogAsNewEvent")) 
        )
        botao_duplicar.click()
        print("  -> Clicado em 'Salvar como novo'.") 
    except Exception as e:
        print(f"‚ùå Erro ao clicar no bot√£o 'Salvar como novo': {e}")
        continue # Pula esta m√°quina se falhar na duplica√ß√£o

    time.sleep(0.8)

    # -- CONTINUAR (XPath Global Flex√≠vel com JS) --
    try:
        xpath_continuar_flexivel = "//span[text()='Continuar']/ancestor::span[contains(@role, 'button')]"
        time.sleep(0.5)
        
        botao_continuar = WebDriverWait(driver, 10).until(
            EC.presence_of_element_located((By.XPATH, xpath_continuar_flexivel)))

        driver.execute_script("arguments[0].click();", botao_continuar)

        print("  -> Clicado em 'Continuar' (XPath Global Flex√≠vel).")
        time.sleep(2)
        
    except Exception as e:
        print(f"‚ùå Erro TOTAL ao clicar no bot√£o 'Continuar' para {nome_maquina}: {e}")
        print(f"‚ö†Ô∏è Processo interrompido para esta m√°quina.")
        continue # Pula a m√°quina se falhar na confirma√ß√£o

    # -- PREENCHER DESCRI√á√ÉO (No Iframe) --
    try:
        iframe = WebDriverWait(driver, 20).until(
            EC.presence_of_element_located((By.XPATH, "//iframe[contains(@title, 'rtES3_formattedRemarks')]"))
        )
        driver.switch_to.frame(iframe)

        corpo_editor = WebDriverWait(driver, 20).until(
            EC.presence_of_element_located((By.CSS_SELECTOR, "body.cke_editable"))
        )
        corpo_editor.clear()
        corpo_editor.send_keys(description_son)
        driver.switch_to.default_content()
        print("  -> Descri√ß√£o do chamado filho preenchida.")

    except Exception as e:
        print(f"‚ùå Erro ao preencher a descri√ß√£o do chamado filho: {e}")
        # Continua mesmo com erro na descri√ß√£o para tentar salvar/BK

    # -- SALVAR CHAMADO FILHO --
    try:
        # ‚ö†Ô∏è REVIS√ÉO DO ID: btlogEvent (Disquete)
        botao_salvar = WebDriverWait(driver, 20).until(
            EC.element_to_be_clickable((By.ID, "btlogEvent")))
        
        botao_salvar.click()
        
        print("  -> Chamado filho salvo com sucesso.")
        time.sleep(2) 
        
    except Exception as e:
        print(f"‚ùå Erro ao clicar no bot√£o Salvar do Chamado Filho: {e}")
        continue # Pula a m√°quina se falhar ao salvar

    # -- BASE DE CONHECIMENTO (Reutilizando a fun√ß√£o) --
    automatizar_bk(driver)

    print(f"‚úîÔ∏è Conclu√≠do o ciclo para a m√°quina: {nome_maquina}.")


print("\nüéâ Automa√ß√£o de cria√ß√£o de chamados filhos conclu√≠da.")
# Opcional: driver.quit() para fechar o navegador no final
